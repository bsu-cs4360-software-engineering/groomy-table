{% extends 'base.html' %}
{% block head %}
    <title>Dashboard - Groomy</title>
    <style>
        table {
            border: 2px solid var(--black);
            border-collapse: collapse;
        }

        tr {
            cursor: pointer;
        }

        tr:nth-child(even) {
            background: var(--grey-background);
        }

        tr:hover {
            color: var(--primary);
        }

        td {
            padding: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            min-width: 500px;
            margin-top: 150px;
            overflow: auto;
            background: var(--grey-background);
            border: var(--clear-border);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .modal-dialog {
            position: relative;
            margin: auto;
            top: 20%;
        }

        .modal-content {
            padding: 20px;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
    </style>
{% endblock %}

{% block nav %}
    <li><a href="#">Business</a></li>
    <li><a href="{{ url_for('dash.create_appointment') }}">Create Appointment</a></li>
    <li><a href="{{ url_for('auth.logout') }}">Logout</a></li>
{% endblock %}

{% block content %}
<section>
    {% if appointments %}
        <table>
            <tbody>
            {% for appointment in appointments %}
                <tr class="appointment-row" 
                    data-id="{{ appointment.id }}"
                    data-client="{{ appointment.customer.client }}"
                    data-email="{{ appointment.customer.email }}"
                    data-number="{{ appointment.customer.phone_number if appointment.customer.phone_number else 'No phone number available' }}"
                    data-date="{{ appointment.date }}"
                    data-time="{{ appointment.display_time }}"
                    data-notes="{{ appointment.note_links | map(attribute='note.content') | join(', ') }}"
                    data-address="{{ appointment.customer.places[0].address if appointment.customer.places else 'No address available' }}">
                    <td>{{ appointment.customer.client }}</td>
                    <td>{{ appointment.date }}</td>
                    <td>{{ appointment.display_time }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="empty-msg" style="text-align: center;">
            No appointments available.
        </div>
    {% endif %}

    <div class="modal" id="appointment-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Appointment Details</h4>
                    <div>
                        <button type="button" class="edit" id="edit-button">Edit</button>
                        <button type="button" class="delete" id="delete-button">Delete</button>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeModal()">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </div>
                <div class="modal-body">
                    <p id="appointment-details"></p>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const rows = document.querySelectorAll('.appointment-row');
        const modal = document.getElementById('appointment-modal');
        const apptDetails = document.getElementById('appointment-details');
        const editButton = document.getElementById('edit-button');
        const deleteButton = document.getElementById('delete-button');

        let currentAppointmentId = null;

        rows.forEach(row => {
            row.addEventListener('click', function() {
                const client = this.dataset.client;
                const email = this.dataset.email;
                const number = this.dataset.number;
                const address = this.dataset.address;
                const date = this.dataset.date;
                const time = this.dataset.time;
                const notes = this.dataset.notes;

                const details = `
                    Client: ${client}<br>
                    Email: ${email}<br>
                    Number: ${number}<br>
                    Address: ${address}<br>
                    Date: ${date}<br>
                    Time: ${time}<br>
                    Notes: ${notes}
                `;

                apptDetails.innerHTML = details;
                currentAppointmentId = this.dataset.id;
                modal.style.display = 'block';
            });
        });

        editButton.addEventListener('click', function() {
            if (currentAppointmentId) {
                // Redirect to the edit page with the appointment ID
                window.location.href = `dashboard/edit_appointment/${currentAppointmentId}`;
            }
        });

        deleteButton.addEventListener('click', function() {
            const confirmation = confirm("Are you sure you want to delete this appointment?");
            if (confirmation && currentAppointmentId) {
                // Make an AJAX request to delete the appointment
                fetch(`/dashboard/delete_appointment/${currentAppointmentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ booked: false })
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();  // Reload the page to reflect changes
                    } else {
                        alert('Failed to delete the appointment. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
            }
        });
    });

    function closeModal() {
        document.getElementById('appointment-modal').style.display = 'none';
    }
</script>
{% endblock %}

{% block footer %}

{% endblock %}